name: Process Booking

on:
  repository_dispatch:
    types: [new-booking]

jobs:
  process-and-store-booking:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout private data repo
        uses: actions/checkout@v3
        with:
          repository: ZeroDegreeStation/Calendar-Data
          # FIXED: Use the correct secret name
          token: ${{ secrets.CALENDAR_DATA_REPO_TOKEN }}
          path: data-repo
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Debug - Show received data
        run: |
          echo "ðŸ“¦ Received booking data:"
          echo '${{ toJson(github.event.client_payload) }}'
      
      - name: Install xlsx
        run: npm install -g xlsx
      
      - name: Process booking data
        env:
          BOOKING_DATA: ${{ toJson(github.event.client_payload) }}
        run: |
          # Create a temporary script
          cat > add-booking.js << 'EOF'
          const XLSX = require('xlsx');
          const fs = require('fs');
          const path = require('path');

          console.log('ðŸ“ Starting booking processing...');

          // Read booking data from environment variable
          const bookingData = JSON.parse(process.env.BOOKING_DATA || '{}');
          console.log('Booking data:', JSON.stringify(bookingData, null, 2));

          if (!bookingData.bookingId) {
            console.error('âŒ No booking ID received');
            process.exit(1);
          }

          // Path to Excel file
          const excelFilePath = path.join('data-repo', 'data', 'calendar-bookings.xlsx');
          console.log('Excel file path:', excelFilePath);

          let workbook;
          let bookings = [];

          try {
            // Read existing file if it exists
            if (fs.existsSync(excelFilePath)) {
              console.log('ðŸ“– Reading existing Excel file...');
              workbook = XLSX.readFile(excelFilePath);
              const worksheet = workbook.Sheets[workbook.SheetNames[0]];
              bookings = XLSX.utils.sheet_to_json(worksheet);
              console.log(`ðŸ“Š Found ${bookings.length} existing bookings`);
            } else {
              console.log('ðŸ“ Creating new Excel file...');
              workbook = XLSX.utils.book_new();
            }
          } catch (error) {
            console.error('âŒ Error reading Excel:', error);
            workbook = XLSX.utils.book_new();
          }

          // Create new booking record
          const newBooking = {
            'Booking ID': bookingData.bookingId || 'UNKNOWN',
            'Date': bookingData.date || '',
            'Customer Name': bookingData.name || '',
            'Email': bookingData.email || '',
            'Phone': bookingData.phone || '',
            'Guests': bookingData.guests || 1,
            'Plan': bookingData.plan || '',
            'Plan Price': bookingData.planPrice || 0,
            'Total Price': bookingData.totalPrice || 0,
            'Status': 'Confirmed',
            'Booking Date': new Date().toISOString().split('T')[0],
            'Special Requests': bookingData.requests || ''
          };

          console.log('âž• Adding new booking:', newBooking['Booking ID']);

          // Add to bookings
          bookings.push(newBooking);

          // Create worksheet
          const worksheet = XLSX.utils.json_to_sheet(bookings);

          // Clear existing sheets
          if (workbook.SheetNames.length > 0) {
            workbook.SheetNames.forEach(name => delete workbook.Sheets[name]);
            workbook.SheetNames = [];
          }

          // Add new sheet
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Bookings');

          // Ensure directory exists
          fs.mkdirSync(path.dirname(excelFilePath), { recursive: true });

          // Write file
          XLSX.writeFile(workbook, excelFilePath);

          console.log(`âœ… Successfully added booking: ${newBooking['Booking ID']}`);
          console.log(`ðŸ“Š Total bookings: ${bookings.length}`);
          EOF

          # Run the script
          node add-booking.js
      
      - name: Commit and push changes
        run: |
          cd data-repo
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add data/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add booking: ${{ github.event.client_payload.bookingId }}"
            git push
            echo "âœ… Changes pushed to private repo"
          fi