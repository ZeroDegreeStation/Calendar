name: Process Booking

on:
  repository_dispatch:
    types: [new-booking]

jobs:
  process-and-store-booking:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout private data repo
        uses: actions/checkout@v3
        with:
          repository: ZeroDegreeStation/Calendar-Data
          token: ${{ secrets.CALENDAR_DATA_REPO_TOKEN }}
          path: data-repo
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Debug - Show received data
        run: |
          echo "ðŸ“¦ Received booking data:"
          echo '${{ toJson(github.event.client_payload) }}'
      
      - name: Create package.json and install xlsx locally
        run: |
          # Create a package.json file
          echo '{
            "name": "booking-processor",
            "version": "1.0.0",
            "dependencies": {
              "xlsx": "latest"
            }
          }' > package.json
          
          # Install xlsx locally (not globally)
          npm install
          
          echo "âœ… xlsx installed locally"
      
      - name: Process booking data
        env:
          BOOKING_DATA: ${{ toJson(github.event.client_payload) }}
        run: |
          # Save booking data to a file
          echo '${{ toJson(github.event.client_payload) }}' > booking.json
          
          # Create the Node.js script
          cat > add-booking.js << 'EOF'
          const XLSX = require('xlsx');
          const fs = require('fs');
          const path = require('path');

          console.log('ðŸ“ Starting booking processing...');
          console.log('Current directory:', process.cwd());
          console.log('Files in current directory:', fs.readdirSync('.'));

          // Read booking data
          let bookingData;
          try {
            const rawData = fs.readFileSync('booking.json', 'utf8');
            bookingData = JSON.parse(rawData);
            console.log('âœ… Booking data loaded:', bookingData.bookingId);
          } catch (error) {
            console.error('âŒ Error reading booking.json:', error);
            // Try to get from env as fallback
            bookingData = JSON.parse(process.env.BOOKING_DATA || '{}');
          }

          if (!bookingData.bookingId) {
            console.error('âŒ No booking ID received');
            process.exit(1);
          }

          // Path to Excel file
          const excelFilePath = path.join('data-repo', 'data', 'calendar-bookings.xlsx');
          console.log('ðŸ“ Excel file path:', excelFilePath);

          // Check if data-repo exists
          if (!fs.existsSync('data-repo')) {
            console.error('âŒ data-repo directory not found');
            process.exit(1);
          }

          let workbook;
          let bookings = [];

          try {
            // Read existing file if it exists
            if (fs.existsSync(excelFilePath)) {
              console.log('ðŸ“– Reading existing Excel file...');
              workbook = XLSX.readFile(excelFilePath);
              const worksheet = workbook.Sheets[workbook.SheetNames[0]];
              bookings = XLSX.utils.sheet_to_json(worksheet);
              console.log(`ðŸ“Š Found ${bookings.length} existing bookings`);
            } else {
              console.log('ðŸ“ Creating new Excel file...');
              workbook = XLSX.utils.book_new();
            }
          } catch (error) {
            console.error('âŒ Error reading Excel:', error);
            workbook = XLSX.utils.book_new();
          }

          // Create new booking record
          const newBooking = {
            'Booking ID': bookingData.bookingId || 'UNKNOWN',
            'Date': bookingData.date || '',
            'Customer Name': bookingData.name || '',
            'Email': bookingData.email || '',
            'Phone': bookingData.phone || '',
            'Guests': bookingData.guests || 1,
            'Plan': bookingData.plan || '',
            'Plan Price': bookingData.planPrice || 0,
            'Total Price': bookingData.totalPrice || 0,
            'Status': 'Confirmed',
            'Booking Date': new Date().toLocaleDateString('en-US'),
            'Special Requests': bookingData.requests || ''
          };

          console.log('âž• Adding new booking:', newBooking['Booking ID']);
          console.log('Booking details:', JSON.stringify(newBooking, null, 2));

          // Add to bookings
          bookings.push(newBooking);

          // Create worksheet
          const worksheet = XLSX.utils.json_to_sheet(bookings);

          // Clear existing sheets
          if (workbook.SheetNames.length > 0) {
            workbook.SheetNames.forEach(name => delete workbook.Sheets[name]);
            workbook.SheetNames = [];
          }

          // Add new sheet
          XLSX.utils.book_append_sheet(workbook, worksheet, 'Bookings');

          // Ensure directory exists
          const dataDir = path.dirname(excelFilePath);
          if (!fs.existsSync(dataDir)) {
            fs.mkdirSync(dataDir, { recursive: true });
          }

          // Write file
          XLSX.writeFile(workbook, excelFilePath);
          console.log(`âœ… Successfully wrote Excel file`);

          // Verify file was created
          if (fs.existsSync(excelFilePath)) {
            const stats = fs.statSync(excelFilePath);
            console.log(`ðŸ“Š Excel file size: ${stats.size} bytes`);
          }

          console.log(`âœ… Successfully added booking: ${newBooking['Booking ID']}`);
          console.log(`ðŸ“Š Total bookings: ${bookings.length}`);
          EOF

          # Run the script
          node add-booking.js
      
      - name: Commit and push changes
        run: |
          cd data-repo
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add data/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add booking: ${{ github.event.client_payload.bookingId }}"
            git push
            echo "âœ… Changes pushed to private repo"
          fi
      
      - name: Notify success
        run: echo "âœ… Booking successfully processed and stored"